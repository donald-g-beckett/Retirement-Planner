<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wealth & Estate Financial Canada â€” Retirement Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: #f8f9fa; color: #1a1a1a; }
    input:focus { outline: none; }
    input[type="text"] { font-family: 'DM Sans', sans-serif; }

    .planner-wrap { min-height: 100vh; padding: 32px 20px; }
    .planner-inner { max-width: 1200px; margin: 0 auto; }

    .planner-title { font-size: 32px; font-weight: 700; color: #0a2463; margin-bottom: 8px; font-family: 'Playfair Display', serif; }
    .planner-subtitle { font-size: 14px; color: #6b7280; margin-bottom: 32px; }

    /* Stats Row */
    .stats-row { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .stat-card { background: #fff; border-radius: 8px; padding: 16px 18px; flex: 1; min-width: 140px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 2px solid #e5e7eb; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: #6b7280; margin-bottom: 6px; font-weight: 600; }
    .stat-value { font-size: 22px; font-weight: 700; }
    .stat-sub { font-size: 11px; color: #6b7280; margin-top: 4px; }

    /* Layout */
    .main-layout { display: flex; gap: 24px; flex-wrap: wrap; }

    /* Inputs Panel */
    .inputs-panel { width: 280px; flex-shrink: 0; background: #fff; border: 2px solid #e5e7eb; border-radius: 8px; padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .inputs-panel h3 { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #0a2463; margin-bottom: 20px; }
    .input-section { border-bottom: 2px solid #f3f4f6; padding-bottom: 18px; margin-bottom: 18px; }
    .input-section:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
    .section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 12px; }

    .field { margin-bottom: 16px; }
    .field-label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: #0a2463; margin-bottom: 6px; }
    .field-wrap { display: flex; align-items: center; background: #fff; border: 2px solid #e5e7eb; border-radius: 6px; padding: 0 12px; transition: border-color 0.2s; }
    .field-wrap:focus-within { border-color: #0a2463; }
    .field-prefix, .field-suffix { color: #6b7280; font-size: 14px; }
    .field-prefix { margin-right: 4px; }
    .field-suffix { margin-left: 4px; font-size: 13px; }
    .field input { width: 100%; padding: 10px 4px; border: none; background: transparent; font-size: 15px; font-weight: 500; color: #1a1a1a; font-family: 'DM Sans', sans-serif; }
    .field-help { font-size: 11px; color: #6b7280; margin-top: 3px; display: block; }

    /* Chart Panel */
    .chart-panel { flex: 1; min-width: 400px; background: #fff; border: 2px solid #e5e7eb; border-radius: 8px; padding: 28px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .chart-title { font-size: 15px; font-weight: 700; color: #0a2463; }
    .chart-legend { display: flex; gap: 16px; font-size: 11px; }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-swatch { width: 12px; height: 3px; border-radius: 2px; display: inline-block; }
    .legend-text { color: #6b7280; }

    .chart-container { position: relative; width: 100%; }
    canvas { width: 100% !important; display: block; }

    .chart-tooltip { position: absolute; pointer-events: none; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 12px; z-index: 10; display: none; }
    .chart-tooltip.visible { display: block; }
    .tooltip-age { font-weight: 600; color: #1a1a1a; margin-bottom: 6px; }
    .tooltip-row { font-size: 11px; margin-bottom: 3px; }

    .chart-note { margin-top: 18px; padding: 16px 20px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 12px; color: #4b5563; line-height: 1.7; }
    .chart-note strong { color: #1f2937; }
    .danger-tip { margin-top: 10px; color: #dc2626; font-weight: 600; }

    /* Footer */
    .planner-footer { margin-top: 24px; padding: 16px 24px; border-top: 2px solid #e5e7eb; font-size: 11px; color: #6b7280; text-align: center; background: #fff; border-radius: 6px; }

    @media (max-width: 780px) {
      .main-layout { flex-direction: column; }
      .inputs-panel { width: 100%; }
      .chart-panel { min-width: unset; }
      .stats-row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="planner-wrap">
    <div class="planner-inner">
      <div style="background: linear-gradient(135deg, #0a2463 0%, #1e3a8a 50%, #3b1f7e 100%); border-radius: 12px; padding: 40px 36px; margin-bottom: 8px; box-shadow: 0 4px 16px rgba(10,36,99,0.3);">
        <h1 style="font-size: 36px; font-weight: 700; color: #ffffff; font-family: 'Playfair Display', serif; margin: 0; text-align: center;">Wealth &amp; Estate Financial Canada Retirement Planner</h1>
      </div>

      <!-- Stats Row -->
      <div class="stats-row" id="statsRow"></div>

      <div class="main-layout">
        <!-- Inputs Panel -->
        <div class="inputs-panel">
          <h3>ðŸ“Š Your Inputs</h3>

          <div class="input-section">
            <div class="section-label" style="color:#0a2463;">Ages</div>
            <div class="field">
              <label class="field-label">Current Age</label>
              <div class="field-wrap"><input type="text" data-key="currentAge" /><span class="field-suffix">yrs</span></div>
            </div>
            <div class="field">
              <label class="field-label">Retirement Age</label>
              <div class="field-wrap"><input type="text" data-key="retirementAge" /><span class="field-suffix">yrs</span></div>
            </div>
            <div class="field">
              <label class="field-label">Plan Through Age</label>
              <div class="field-wrap"><input type="text" data-key="endAge" /><span class="field-suffix">yrs</span></div>
            </div>
          </div>

          <div class="input-section">
            <div class="section-label" style="color:#d4af37;">Accumulation</div>
            <div class="field">
              <label class="field-label">Current Portfolio</label>
              <div class="field-wrap"><span class="field-prefix">$</span><input type="text" data-key="startingPortfolio" /></div>
            </div>
            <div class="field">
              <label class="field-label">Annual Contribution</label>
              <div class="field-wrap"><span class="field-prefix">$</span><input type="text" data-key="annualContribution" /></div>
              <span class="field-help">Until retirement</span>
            </div>
            <div class="field">
              <label class="field-label">Avg Growth Rate</label>
              <div class="field-wrap"><input type="text" data-key="growthRate" /><span class="field-suffix">%</span></div>
            </div>
          </div>

          <div class="input-section">
            <div class="section-label" style="color:#dc2626;">Withdrawals</div>
            <div class="field">
              <label class="field-label">Phase 1 Annual Withdrawal</label>
              <div class="field-wrap"><span class="field-prefix">$</span><input type="text" data-key="phase1Withdrawal" /></div>
              <span class="field-help" id="phase1Help"></span>
            </div>
            <div class="field">
              <label class="field-label">Phase 2 Starts At Age</label>
              <div class="field-wrap"><input type="text" data-key="phase2Age" /><span class="field-suffix">yrs</span></div>
            </div>
            <div class="field">
              <label class="field-label">Phase 2 Annual Withdrawal</label>
              <div class="field-wrap"><span class="field-prefix">$</span><input type="text" data-key="phase2Withdrawal" /></div>
              <span class="field-help" id="phase2Help"></span>
            </div>
          </div>
        </div>

        <!-- Chart Panel -->
        <div class="chart-panel">
          <div class="chart-header">
            <span class="chart-title">Portfolio Value vs. Cumulative Withdrawals</span>
            <div class="chart-legend">
              <span class="legend-item"><span class="legend-swatch" style="background:#0a2463;"></span><span class="legend-text">Portfolio</span></span>
              <span class="legend-item"><span class="legend-swatch" style="background:#dc2626;"></span><span class="legend-text">Cumulative Withdrawals</span></span>
            </div>
          </div>

          <div class="chart-container">
            <canvas id="chart" height="420"></canvas>
            <div class="chart-tooltip" id="tooltip">
              <div class="tooltip-age" id="tooltipAge"></div>
              <div class="tooltip-row" id="tooltipPortfolio" style="color:#0a2463;"></div>
              <div class="tooltip-row" id="tooltipWithdrawals" style="color:#dc2626;"></div>
            </div>
          </div>

          <div class="chart-note" id="chartNote"></div>
        </div>
      </div>

      <div class="planner-footer">
        Â© 2026 Donald G. Beckett, CIM, FCSI. All rights reserved.<br /><br />
        <span style="display:block; text-align:left;">This model assumes a constant average annual growth rate and does not account for inflation, taxes, market volatility, or sequence-of-returns risk.
        For illustration purposes only â€” not financial advice. Consult your advisor for personalized planning.</span>
      </div>
    </div>
  </div>

  <script>
    // â”€â”€ State â”€â”€
    const state = {
      currentAge: 55,
      retirementAge: 65,
      endAge: 95,
      startingPortfolio: 500000,
      annualContribution: 25000,
      growthRate: 7.0,
      phase1Withdrawal: 50000,
      phase2Age: 75,
      phase2Withdrawal: 70000,
    };

    // â”€â”€ Helpers â”€â”€
    const fmtC = v => {
      if (v >= 1e6) return '$' + (v / 1e6).toFixed(2) + 'M';
      if (v >= 1e3) return '$' + (v / 1e3).toFixed(0) + 'K';
      return '$' + v.toFixed(0);
    };
    const fmtFull = v => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v);
    const fmtCommas = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    const isFloat = key => key === 'growthRate';

    // â”€â”€ Compute Data â”€â”€
    function computeData() {
      const { currentAge, retirementAge, endAge, startingPortfolio, annualContribution, growthRate, phase1Withdrawal, phase2Age, phase2Withdrawal } = state;
      const pts = [];
      let port = startingPortfolio;
      let totalW = 0;
      const rate = growthRate / 100;
      for (let age = currentAge; age <= endAge; age++) {
        if (age < retirementAge) {
          port = port * (1 + rate) + annualContribution;
          pts.push({ age, portfolioValue: Math.round(port), cumulativeWithdrawals: 0, phase: 'accumulation' });
        } else {
          const w = age >= phase2Age ? phase2Withdrawal : phase1Withdrawal;
          port = port * (1 + rate) - w;
          totalW += w;
          pts.push({ age, portfolioValue: Math.max(0, Math.round(port)), cumulativeWithdrawals: Math.round(totalW), annualWithdrawal: w, phase: age >= phase2Age ? 'phase2' : 'phase1' });
        }
      }
      return pts;
    }

    function computeStats(data) {
      const { retirementAge, endAge, phase2Age, phase1Withdrawal, phase2Withdrawal } = state;
      const atRetire = data.find(d => d.age === retirementAge);
      const atEnd = data.find(d => d.age === endAge);
      const peak = Math.max(...data.map(d => d.portfolioValue));
      const cross = data.find(d => d.cumulativeWithdrawals > 0 && d.cumulativeWithdrawals >= d.portfolioValue);
      const depletion = data.find(d => d.portfolioValue <= 0 && d.age >= retirementAge);
      return {
        portfolioAtRetirement: atRetire ? atRetire.portfolioValue : 0,
        peakPortfolio: peak,
        totalWithdrawnAtEnd: atEnd ? atEnd.cumulativeWithdrawals : 0,
        portfolioAtEnd: atEnd ? atEnd.portfolioValue : 0,
        crossoverAge: cross ? cross.age : null,
        depletionAge: depletion ? depletion.age : null,
        isDanger: depletion !== null || (cross && cross.age <= endAge),
      };
    }

    // â”€â”€ Render Stats â”€â”€
    function renderStats(stats) {
      const { retirementAge, endAge } = state;
      const row = document.getElementById('statsRow');
      const cards = [
        { label: 'At Retirement', value: fmtC(stats.portfolioAtRetirement), color: '#0a2463', sub: 'Age ' + retirementAge },
        { label: 'Peak Value', value: fmtC(stats.peakPortfolio), color: '#d4af37', sub: '' },
        { label: 'Total Withdrawn', value: fmtC(stats.totalWithdrawnAtEnd), color: '#dc2626', sub: 'By age ' + endAge },
        { label: 'At Age ' + endAge, value: fmtC(stats.portfolioAtEnd), color: stats.portfolioAtEnd > 0 ? '#0a7e3e' : '#dc2626', sub: stats.portfolioAtEnd > 0 ? 'Remaining' : 'Depleted' },
      ];
      row.innerHTML = cards.map(c => `
        <div class="stat-card" style="border-color:${c.color};">
          <div class="stat-label">${c.label}</div>
          <div class="stat-value" style="color:${c.color};">${c.value}</div>
          ${c.sub ? `<div class="stat-sub">${c.sub}</div>` : ''}
        </div>
      `).join('');
    }

    // â”€â”€ Render Note â”€â”€
    function renderNote(stats) {
      const { endAge, phase1Withdrawal, phase2Withdrawal } = state;
      const note = document.getElementById('chartNote');
      let html = `<strong>How to read this chart:</strong> The navy line (portfolio value) should always stay <em>above</em> the red line (cumulative withdrawals). When the red line crosses above the navy line, you're withdrawing faster than the portfolio grows â€” <span style="color:#dc2626;font-weight:600;">eventual depletion is likely</span>. Adjust withdrawal amounts until the portfolio remains sustainable through age ${endAge}.`;
      if (stats.isDanger) {
        const bigger = phase2Withdrawal > phase1Withdrawal ? phase2Withdrawal : phase1Withdrawal;
        const phase = phase2Withdrawal > phase1Withdrawal ? '2' : '1';
        html += `<div class="danger-tip">ðŸ’¡ Try reducing Phase ${phase} withdrawals by ${fmtC(Math.round(bigger * 0.15))} to see if sustainability improves.</div>`;
      }
      note.innerHTML = html;
    }

    // â”€â”€ Canvas Chart â”€â”€
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    const tooltipEl = document.getElementById('tooltip');
    let chartData = [];
    let chartStats = {};

    function drawChart() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.parentElement.getBoundingClientRect();
      const W = rect.width;
      const H = 420;
      canvas.width = W * dpr;
      canvas.height = H * dpr;
      canvas.style.width = W + 'px';
      canvas.style.height = H + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      const pad = { top: 36, right: 24, bottom: 42, left: 72 };
      const cw = W - pad.left - pad.right;
      const ch = H - pad.top - pad.bottom;

      const data = chartData;
      if (!data.length) return;

      const ages = data.map(d => d.age);
      const allVals = data.flatMap(d => [d.portfolioValue, d.cumulativeWithdrawals]);
      const minAge = Math.min(...ages);
      const maxAge = Math.max(...ages);
      const maxVal = Math.max(...allVals) * 1.08;

      const xScale = age => pad.left + ((age - minAge) / (maxAge - minAge)) * cw;
      const yScale = val => pad.top + ch - (val / maxVal) * ch;

      // Background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, W, H);

      // Grid
      ctx.strokeStyle = '#e5e7eb';
      ctx.setLineDash([3, 3]);
      ctx.lineWidth = 1;
      const yTicks = 6;
      for (let i = 0; i <= yTicks; i++) {
        const val = (maxVal / yTicks) * i;
        const y = yScale(val);
        ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
        ctx.fillStyle = '#6b7280'; ctx.font = '11px DM Sans'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
        ctx.fillText(fmtC(val), pad.left - 8, y);
      }
      const ageStep = Math.max(1, Math.ceil((maxAge - minAge) / 12));
      for (let a = minAge; a <= maxAge; a += ageStep) {
        const x = xScale(a);
        ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, pad.top + ch); ctx.stroke();
        ctx.fillStyle = '#6b7280'; ctx.font = '11px DM Sans'; ctx.textAlign = 'center'; ctx.textBaseline = 'top';
        ctx.fillText(a, x, pad.top + ch + 8);
      }
      ctx.setLineDash([]);

      // Axis label
      ctx.fillStyle = '#6b7280'; ctx.font = '11px DM Sans'; ctx.textAlign = 'center';
      ctx.fillText('Age', pad.left + cw / 2, H - 4);

      // Reference lines
      const drawRef = (age, color, label, dashArr) => {
        if (age < minAge || age > maxAge) return;
        const x = xScale(age);
        ctx.strokeStyle = color; ctx.setLineDash(dashArr); ctx.lineWidth = 1.5; ctx.globalAlpha = 0.8;
        ctx.beginPath(); ctx.moveTo(x, pad.top); ctx.lineTo(x, pad.top + ch); ctx.stroke();
        ctx.globalAlpha = 1; ctx.setLineDash([]);
        ctx.fillStyle = color; ctx.font = '600 10px DM Sans'; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
        ctx.fillText(label, x, pad.top - 4);
      };
      drawRef(state.retirementAge, '#d4af37', 'Retire ' + state.retirementAge, [6, 4]);
      drawRef(state.phase2Age, '#d97706', 'Phase 2: ' + state.phase2Age, [6, 4]);
      if (chartStats.crossoverAge) drawRef(chartStats.crossoverAge, '#dc2626', 'Cross ' + chartStats.crossoverAge, [4, 3]);

      // Area fills
      const drawArea = (key, gradTopColor) => {
        ctx.beginPath();
        ctx.moveTo(xScale(data[0].age), yScale(0));
        data.forEach(d => ctx.lineTo(xScale(d.age), yScale(d[key])));
        ctx.lineTo(xScale(data[data.length - 1].age), yScale(0));
        ctx.closePath();
        const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
        grad.addColorStop(0, gradTopColor.replace(')', ',0.15)').replace('rgb', 'rgba'));
        grad.addColorStop(1, gradTopColor.replace(')', ',0.02)').replace('rgb', 'rgba'));
        // Use hex-to-rgba manually
        ctx.fillStyle = gradTopColor;
        ctx.globalAlpha = 0.1;
        ctx.fill();
        ctx.globalAlpha = 1;
      };
      drawArea('portfolioValue', '#0a2463');
      drawArea('cumulativeWithdrawals', '#dc2626');

      // Lines
      const drawLine = (key, color) => {
        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.lineCap = 'round';
        ctx.beginPath();
        data.forEach((d, i) => { const x = xScale(d.age), y = yScale(d[key]); i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
        ctx.stroke();
      };
      drawLine('portfolioValue', '#0a2463');
      drawLine('cumulativeWithdrawals', '#dc2626');

      // Store scales for tooltip
      canvas._scales = { xScale, yScale, minAge, maxAge, pad, cw, ch };
    }

    // â”€â”€ Tooltip â”€â”€
    canvas.addEventListener('mousemove', e => {
      if (!chartData.length || !canvas._scales) return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const { xScale, minAge, maxAge, pad } = canvas._scales;
      if (mx < pad.left || mx > rect.width - pad.right) { tooltipEl.classList.remove('visible'); return; }
      const hoveredAge = Math.round(minAge + ((mx - pad.left) / (rect.width - pad.left - pad.right)) * (maxAge - minAge));
      const dp = chartData.find(d => d.age === hoveredAge);
      if (!dp) { tooltipEl.classList.remove('visible'); return; }
      document.getElementById('tooltipAge').textContent = 'Age ' + dp.age;
      document.getElementById('tooltipPortfolio').textContent = 'Portfolio Value: ' + fmtFull(dp.portfolioValue);
      document.getElementById('tooltipWithdrawals').textContent = 'Cumulative Withdrawals: ' + fmtFull(dp.cumulativeWithdrawals);
      tooltipEl.classList.add('visible');
      let tx = mx + 16;
      if (tx + 200 > rect.width) tx = mx - 210;
      tooltipEl.style.left = tx + 'px';
      tooltipEl.style.top = (e.clientY - rect.top - 40) + 'px';
    });
    canvas.addEventListener('mouseleave', () => tooltipEl.classList.remove('visible'));

    // â”€â”€ Input Binding â”€â”€
    function bindInputs() {
      document.querySelectorAll('[data-key]').forEach(input => {
        const key = input.dataset.key;
        input.value = isFloat(key) ? state[key] : fmtCommas(state[key]);
        input.addEventListener('input', e => {
          const raw = e.target.value.replace(/,/g, '');
          const num = Number(raw);
          if (!isNaN(num)) {
            state[key] = num;
            if (!isFloat(key)) e.target.value = fmtCommas(num);
            update();
          }
        });
      });
    }

    function updateHelpTexts() {
      document.getElementById('phase1Help').textContent = 'Age ' + state.retirementAge + ' to ' + (state.phase2Age - 1);
      document.getElementById('phase2Help').textContent = 'Age ' + state.phase2Age + ' to ' + state.endAge;
    }

    // â”€â”€ Master Update â”€â”€
    function update() {
      chartData = computeData();
      chartStats = computeStats(chartData);
      renderStats(chartStats);
      renderNote(chartStats);
      updateHelpTexts();
      drawChart();
    }

    // â”€â”€ Init â”€â”€
    bindInputs();
    update();
    window.addEventListener('resize', drawChart);
  </script>
</body>
</html>
.
